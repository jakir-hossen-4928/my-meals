rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to validate user profile data
    function isValidProfileData() {
      let data = request.resource.data;
      return data.keys().hasAll(['updatedAt']) &&
             (data.updatedAt is timestamp || data.updatedAt is string) &&
             (!('groceryCost' in data) || data.groceryCost is number) &&
             (!('totalMembers' in data) || (data.totalMembers is number && data.totalMembers >= 1)) &&
             (!('mealsPerDay' in data) || (data.mealsPerDay is number && data.mealsPerDay >= 1 && data.mealsPerDay <= 10)) &&
             (!('displayName' in data) || (data.displayName is string && data.displayName.size() <= 100)) &&
             (!('photoURL' in data) || (data.photoURL is string && data.photoURL.size() <= 500)) &&
             (!('coverPhotoURL' in data) || (data.coverPhotoURL is string && data.coverPhotoURL.size() <= 500)) &&
             (!('mealTimes' in data) || (data.mealTimes is map)) &&
             (!('perMealCost' in data) || (data.perMealCost is number && data.perMealCost >= 0));
    }

    // Helper function to validate meal record data
    function isValidMealData() {
      let data = request.resource.data;
      return data.keys().hasAll(['date', 'timestamp']) &&
             data.date is string &&
             data.date.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$') &&
             data.timestamp is string &&
             (!('breakfast' in data) || data.breakfast is bool) &&
             (!('lunch' in data) || data.lunch is bool) &&
             (!('dinner' in data) || data.dinner is bool) &&
             (!('snack' in data) || data.snack is bool) &&
             (!('customMeals' in data) || data.customMeals is map);
    }

    // Users collection - stores user profile data
    match /users/{userId} {
      // Allow read if user is authenticated and owns the document
      allow read: if isOwner(userId);

      // Allow create if user is authenticated and creating their own document
      allow create: if isOwner(userId) && isValidProfileData();

      // Allow update if user owns the document and data is valid
      allow update: if isOwner(userId) && isValidProfileData();

      // Prevent deletion of user profiles
      allow delete: if false;

      // Meals subcollection - stores daily meal records
      match /meals/{mealId} {
        // Allow read if user owns the parent document
        allow read: if isOwner(userId);

        // Allow create if user owns the parent document and data is valid
        allow create: if isOwner(userId) && isValidMealData();

        // Allow update if user owns the document and data is valid
        allow update: if isOwner(userId) && isValidMealData();

        // Allow delete if user owns the document (to remove old records)
        allow delete: if isOwner(userId);
      }

      // Meal configurations subcollection - stores custom meal configurations
      match /mealConfigs/{configId} {
        // Allow read if user owns the parent document
        allow read: if isOwner(userId);

        // Allow create/update if user owns the parent document
        allow create, update: if isOwner(userId) &&
                                 request.resource.data.keys().hasAll(['updatedAt']) &&
                                 request.resource.data.updatedAt is timestamp;

        // Allow delete if user owns the document
        allow delete: if isOwner(userId);
      }
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
